<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bomb Squad - Multiplayer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        #gameContainer {
            position: relative;
            width: 100%;
            height: 100%;
            max-width: 1200px;
            max-height: 800px;
        }

        #gameCanvas {
            background: linear-gradient(180deg, #87ceeb 0%, #98d8e8 100%);
            border: 4px solid #333;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            display: block;
            cursor: crosshair;
        }

        #ui {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 20px;
            color: white;
            font-size: 18px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            pointer-events: none;
        }

        #teamScores {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .team-score {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 24px;
        }

        .red-team {
            background: rgba(220, 20, 60, 0.8);
        }

        .blue-team {
            background: rgba(30, 144, 255, 0.8);
        }

        #playerInfo {
            text-align: center;
            font-size: 16px;
        }

        #menu {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            color: white;
        }

        #menu h1 {
            font-size: 48px;
            margin-bottom: 20px;
            color: #ffd700;
        }

        #menu input {
            padding: 12px;
            font-size: 16px;
            margin: 10px 0;
            width: 250px;
            border: none;
            border-radius: 5px;
        }

        #menu button {
            padding: 12px 30px;
            font-size: 18px;
            margin: 10px 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.2s;
        }

        #menu button:hover {
            transform: scale(1.05);
        }

        .red-btn {
            background: #dc143c;
            color: white;
        }

        .blue-btn {
            background: #1e90ff;
            color: white;
        }

        #controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-size: 14px;
            pointer-events: none;
        }

        .hidden {
            display: none;
        }

        #winMessage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            padding: 50px;
            border-radius: 15px;
            text-align: center;
            color: white;
            font-size: 36px;
            font-weight: bold;
            border: 5px solid #ffd700;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="menu">
            <h1>ðŸ’£ BOMB SQUAD ðŸ’£</h1>
            <p style="margin-bottom: 20px;">Capture the flag and score in enemy goal!</p>
            <input type="text" id="playerName" placeholder="Enter your name" maxlength="15">
            <br>
            <button class="red-btn" onclick="joinGame('red')">Join Red Team</button>
            <button class="blue-btn" onclick="joinGame('blue')">Join Blue Team</button>
            <p style="margin-top: 20px; font-size: 12px;">Connecting to server...</p>
        </div>

        <canvas id="gameCanvas" class="hidden"></canvas>

        <div id="ui" class="hidden">
            <div id="teamScores">
                <div class="team-score red-team">ðŸ”´ Red: <span id="redScore">0</span></div>
                <div class="team-score blue-team">ðŸ”µ Blue: <span id="blueScore">0</span></div>
            </div>
            <div id="playerInfo">Players: <span id="playerCount">0</span></div>
        </div>

        <div id="controls" class="hidden">
            <b>WASD:</b> Move | <b>MOUSE:</b> Aim | <b>CLICK:</b> Punch | <b>E:</b> Pick/Drop Flag
        </div>

        <div id="winMessage" class="hidden"></div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const menu = document.getElementById('menu');
        const ui = document.getElementById('ui');
        const controls = document.getElementById('controls');
        const winMessage = document.getElementById('winMessage');

        // Set canvas size
        canvas.width = 1200;
        canvas.height = 600;

        // WebSocket connection
        let ws;
        let playerId;
        let players = {};
        let flag = null;
        let goals = { red: null, blue: null };
        let scores = { red: 0, blue: 0 };

        // Input handling
        const keys = {};
        let mousePos = { x: 0, y: 0 };
        let mouseDown = false;

        // Connect to WebSocket server
        function connectToServer() {
            // ws = new WebSocket('https://89t74lt3-4577.inc1.devtunnels.ms/');
            ws = new WebSocket("ws://localhost:4577");

            ws.onopen = () => {
                console.log('Connected to server');
                menu.querySelector('p').textContent = 'Connected! Choose your team';
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleServerMessage(data);
            };

            ws.onclose = () => {
                console.log('Disconnected from server');
                alert('Disconnected from server');
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                menu.querySelector('p').textContent = 'Connection error. Please refresh.';
            };
        }

        function joinGame(team) {
            const name = document.getElementById('playerName').value.trim() || 'Player';
            
            ws.send(JSON.stringify({
                type: 'join',
                name: name,
                team: team
            }));

            menu.classList.add('hidden');
            canvas.classList.remove('hidden');
            ui.classList.remove('hidden');
            controls.classList.remove('hidden');
        }

        function handleServerMessage(data) {
            switch(data.type) {
                case 'init':
                    playerId = data.id;
                    players = data.players;
                    flag = data.flag;
                    goals = data.goals;
                    scores = data.scores;
                    updateScores();
                    break;
                case 'update':
                    players = data.players;
                    flag = data.flag;
                    scores = data.scores;
                    updateScores();
                    break;
                case 'win':
                    showWinMessage(data.team);
                    break;
            }
        }

        function updateScores() {
            document.getElementById('redScore').textContent = scores.red;
            document.getElementById('blueScore').textContent = scores.blue;
            document.getElementById('playerCount').textContent = Object.keys(players).length;
        }

        function showWinMessage(team) {
            const color = team === 'red' ? 'ðŸ”´' : 'ðŸ”µ';
            winMessage.textContent = `${color} ${team.toUpperCase()} TEAM WINS! ðŸ†`;
            winMessage.style.borderColor = team === 'red' ? '#dc143c' : '#1e90ff';
            winMessage.classList.remove('hidden');

            setTimeout(() => {
                winMessage.classList.add('hidden');
            }, 3000);
        }

        // Input listeners
        document.addEventListener('keydown', (e) => {
            keys[e.key.toLowerCase()] = true;
            
            if (e.key.toLowerCase() === 'e') {
                ws.send(JSON.stringify({ type: 'pickFlag' }));
            }
        });

        document.addEventListener('keyup', (e) => {
            keys[e.key.toLowerCase()] = false;
        });

        canvas.addEventListener('mousemove', (e) => {
            const rect = canvas.getBoundingClientRect();
            mousePos.x = e.clientX - rect.left;
            mousePos.y = e.clientY - rect.top;
        });

       // ðŸ§  SPACEBAR to punch
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space') {
                e.preventDefault(); // stop page scroll

                if (ws && ws.readyState === WebSocket.OPEN && players[playerId]) {
                    const me = players[playerId];

                    // Compute angle from your player position to your mouse
                    const angle = Math.atan2(mousePos.y - me.y, mousePos.x - me.x);

                    ws.send(JSON.stringify({ 
                        type: 'punch',
                        angle: angle
                    }));
                }
            }
        });

        document.addEventListener('keyup', (e) => {
            if (e.code === 'Space') {
                mouseDown = false;
            }
        });


        // Game loop
        function gameLoop() {
            // Send input to server
            if (ws && ws.readyState === WebSocket.OPEN) {
                const input = {
                    type: 'input',
                    keys: {
                    w: keys['arrowup'] || false,
                    a: keys['arrowleft'] || false,
                    s: keys['arrowdown'] || false,
                    d: keys['arrowright'] || false
                },
                    mouse: mousePos
                };
                ws.send(JSON.stringify(input));
            }

            // Render
            render();
            requestAnimationFrame(gameLoop);
        }

        function render() {
            // Clear canvas
            ctx.fillStyle = '#7ec850';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw center line
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 3;
            ctx.setLineDash([20, 10]);
            ctx.beginPath();
            ctx.moveTo(canvas.width / 2, 0);
            ctx.lineTo(canvas.width / 2, canvas.height);
            ctx.stroke();
            ctx.setLineDash([]);

            // Draw goals
            if (goals.red) {
                ctx.fillStyle = 'rgba(220, 20, 60, 0.3)';
                ctx.fillRect(goals.red.x, goals.red.y, goals.red.w, goals.red.h);
                ctx.strokeStyle = '#dc143c';
                ctx.lineWidth = 4;
                ctx.strokeRect(goals.red.x, goals.red.y, goals.red.w, goals.red.h);
            }
            if (goals.blue) {
                ctx.fillStyle = 'rgba(30, 144, 255, 0.3)';
                ctx.fillRect(goals.blue.x, goals.blue.y, goals.blue.w, goals.blue.h);
                ctx.strokeStyle = '#1e90ff';
                ctx.lineWidth = 4;
                ctx.strokeRect(goals.blue.x, goals.blue.y, goals.blue.w, goals.blue.h);
            }

            // Draw flag
            if (flag && !flag.carrier) {
                ctx.save();
                ctx.translate(flag.x, flag.y);
                
                // Flag pole
                ctx.fillStyle = '#8b4513';
                ctx.fillRect(-2, -20, 4, 20);
                
                // Flag
                ctx.fillStyle = '#ffd700';
                ctx.beginPath();
                ctx.moveTo(0, -20);
                ctx.lineTo(20, -15);
                ctx.lineTo(0, -10);
                ctx.closePath();
                ctx.fill();
                
                ctx.restore();
            }

            // Draw players
            for (let id in players) {
                const p = players[id];
                
                ctx.save();
                ctx.translate(p.x, p.y);
                ctx.rotate(p.angle);

                // Player body
                ctx.fillStyle = p.team === 'red' ? '#dc143c' : '#1e90ff';
                ctx.beginPath();
                ctx.arc(0, 0, p.r, 0, Math.PI * 2);
                ctx.fill();

                // Player outline
                ctx.strokeStyle = id === playerId ? '#ffd700' : '#333';
                ctx.lineWidth = id === playerId ? 3 : 2;
                ctx.stroke();

                // Direction indicator
                ctx.fillStyle = 'white';
                ctx.beginPath();
                ctx.arc(p.r * 0.5, 0, 3, 0, Math.PI * 2);
                ctx.fill();

                ctx.restore();

                // Player name
                ctx.fillStyle = 'white';
                ctx.strokeStyle = 'black';
                ctx.lineWidth = 3;
                ctx.font = 'bold 12px Arial';
                ctx.textAlign = 'center';
                ctx.strokeText(p.name, p.x, p.y - p.r - 5);
                ctx.fillText(p.name, p.x, p.y - p.r - 5);

                // Flag on player
                if (flag && flag.carrier === id) {
                    ctx.save();
                    ctx.translate(p.x, p.y - p.r - 10);
                    ctx.fillStyle = '#8b4513';
                    ctx.fillRect(-2, -15, 4, 15);
                    ctx.fillStyle = '#ffd700';
                    ctx.beginPath();
                    ctx.moveTo(0, -15);
                    ctx.lineTo(15, -11);
                    ctx.lineTo(0, -7);
                    ctx.closePath();
                    ctx.fill();
                    ctx.restore();
                }
            }
        }

        // Start
        connectToServer();
        gameLoop();
    </script>
</body>
</html>